<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Taste: AI News Analyst</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Simple loading spinner */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #3b82f6;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        /* Summary rendering fixes */
        #summary-output {
            white-space: normal; /* don't preserve literal newlines */
            text-align: left;    /* avoid justification spacing */
            overflow-wrap: break-word;
            word-break: normal;
        }
        .article-summaries { padding-left: 1rem; }
        /* Chat message styling */
        .chat-message {
            display: flex;
            animation: slideIn 0.3s ease-in-out;
        }
        .chat-message.text-right {
            justify-content: flex-end;
        }
        .chat-message.text-left {
            justify-content: flex-start;
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="font-sans min-h-screen" style="background-image: url('images/white-abstract-background-3d-paper-style/3253510.jpg'); background-attachment: fixed; background-size: cover; background-position: center;">
    
    <!-- Header -->
    <div class="bg-white border-b border-slate-200">
        <div class="max-w-7xl mx-auto px-4 md:px-8 py-6 flex items-center justify-between">
            <h1 class="text-3xl font-bold text-slate-900">Taste</h1>
            <p class="text-slate-600">AI-Powered News Curator</p>
        </div>
    </div>

    <div class="bg-white bg-opacity-40 min-h-screen">
        <div class="max-w-5xl mx-auto px-4 md:px-8">

        <!-- Section 1: Category Selection -->
        <div class="bg-white rounded-none shadow-none border-none py-8">
            <div class="bg-white px-0 py-0 border-none">
                <h2 class="text-2xl font-bold text-slate-900 mb-6">Select Your Interests</h2>
            </div>
            <div class="p-0">
                <!-- Category Checkboxes -->
                <div id="category-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-8">
                <!-- Categories -->
                <label class="flex items-center p-4 bg-white rounded-lg border-2 border-slate-300 hover:border-slate-400 hover:bg-slate-50 cursor-pointer transition-all">
                    <input type="checkbox" name="category" value="AI" class="h-5 w-5 text-slate-600 rounded focus:ring-2 focus:ring-slate-400 mr-3">
                    <span class="font-medium text-slate-700">Artificial Intelligence</span>
                </label>
                <label class="flex items-center p-4 bg-white rounded-lg border-2 border-slate-300 hover:border-slate-400 hover:bg-slate-50 cursor-pointer transition-all">
                    <input type="checkbox" name="category" value="Web3" class="h-5 w-5 text-slate-600 rounded focus:ring-2 focus:ring-slate-400 mr-3">
                    <span class="font-medium text-slate-700">Web3 & Crypto</span>
                </label>
                <label class="flex items-center p-4 bg-white rounded-lg border-2 border-slate-300 hover:border-slate-400 hover:bg-slate-50 cursor-pointer transition-all">
                    <input type="checkbox" name="category" value="StockMarket" class="h-5 w-5 text-slate-600 rounded focus:ring-2 focus:ring-slate-400 mr-3">
                    <span class="font-medium text-slate-700">Stock Market</span>
                </label>
                <label class="flex items-center p-4 bg-white rounded-lg border-2 border-slate-300 hover:border-slate-400 hover:bg-slate-50 cursor-pointer transition-all">
                    <input type="checkbox" name="category" value="Geopolitics" class="h-5 w-5 text-slate-600 rounded focus:ring-2 focus:ring-slate-400 mr-3">
                    <span class="font-medium text-slate-700">Geopolitics</span>
                </label>
                <label class="flex items-center p-4 bg-white rounded-lg border-2 border-slate-300 hover:border-slate-400 hover:bg-slate-50 cursor-pointer transition-all">
                    <input type="checkbox" name="category" value="Science" class="h-5 w-5 text-slate-600 rounded focus:ring-2 focus:ring-slate-400 mr-3">
                    <span class="font-medium text-slate-700">Science</span>
                </label>
                <label class="flex items-center p-4 bg-white rounded-lg border-2 border-slate-300 hover:border-slate-400 hover:bg-slate-50 cursor-pointer transition-all">
                    <input type="checkbox" name="category" value="Business" class="h-5 w-5 text-slate-600 rounded focus:ring-2 focus:ring-slate-400 mr-3">
                    <span class="font-medium text-slate-700">Business</span>
                </label>
            </div>
            
            <button id="build-feed-btn" onclick="buildFeed()" class="w-full bg-slate-700 text-white px-6 py-3 rounded-lg hover:bg-slate-800 transition-all font-semibold text-lg flex items-center justify-center">
                <span>Build & Analyze My Feed</span>
            </button>
            </div>
        </div>

        <!-- Section 2: Aggregated Information -->
        <div class="bg-white rounded-xl shadow-lg overflow-hidden my-8">
            <div class="bg-white px-6 py-4 border-b border-slate-200">
                <h2 class="text-2xl font-bold text-slate-900">Your Aggregated Brief</h2>
                <p class="text-slate-600 text-sm mt-1">AI-generated summary of the latest articles</p>
            </div>
            <div class="p-6 md:p-8">
                <div id="summary-output" class="min-h-[15rem] space-y-4">
                    <p class="text-slate-500 text-center py-8">Select categories and click "Build & Analyze" to generate your personalized brief...</p>
                </div>
            </div>
        </div>

        <!-- Section 3: Chat with your Feed -->
        <div class="bg-white rounded-xl shadow-lg overflow-hidden my-8 mb-16">
            <div class="bg-white px-6 py-4 border-b border-slate-200">
                <h2 class="text-2xl font-bold text-slate-900">Ask Questions in Your Domain</h2>
                <p class="text-slate-600 text-sm mt-1">Interact with your feed using natural language</p>
            </div>
            <div class="p-6 md:p-8 space-y-4">
                
                <!-- Chat Window -->
                <div id="chat-window" class="border-2 border-slate-200 rounded-lg bg-slate-50 h-96 overflow-y-auto p-4 space-y-3 font-medium">
                    <div class="text-slate-400 italic text-sm text-center py-16">Chat history will appear here...</div>
                </div>
                
                <!-- Chat Input -->
                <div class="flex gap-3">
                    <input type="text" id="chat-input" placeholder="Ask a question about your feed..." class="flex-grow border-2 border-slate-300 rounded-lg p-4 text-base focus:border-slate-400 focus:ring-2 focus:ring-slate-200 focus:outline-none transition-all disabled:bg-slate-100 disabled:cursor-not-allowed" disabled>
                    <button id="chat-submit" onclick="askQuestion()" class="bg-slate-700 text-white px-6 py-4 rounded-lg hover:bg-slate-800 transition-all font-semibold text-base disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2" disabled>
                        <span>Ask</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="text-center text-slate-400 text-sm py-8 border-t border-slate-200 mt-12">
            <p>Taste Â© 2025 | AI News Curator</p>
        </div>
        </div>
    </div>

    <script>
        const API_URL = "http://127.0.0.1:5000";
        let isFeedBuilt = false;

        // Persist selection to localStorage so page reloads (e.g., from dev server file changes)
        function saveSelectedCategories(categories) {
            try { localStorage.setItem('selected_categories', JSON.stringify(categories)); } catch(e) { /* ignore */ }
        }

        function restoreSelectedCategories() {
            try {
                const raw = localStorage.getItem('selected_categories');
                if (!raw) return [];
                const arr = JSON.parse(raw);
                if (!Array.isArray(arr)) return [];
                // check checkboxes and update label styles
                arr.forEach(val => {
                    const cb = document.querySelector(`input[name="category"][value="${val}"]`);
                    if (cb) {
                        cb.checked = true;
                        const label = cb.closest('label');
                        if (label) label.classList.add('bg-slate-100','border-slate-400');
                    }
                });
                // Also render pills view
                if (arr.length > 0) {
                    const parent = document.getElementById('summary-output');
                    let pills = document.getElementById('selected-categories-pills');
                    if (!pills) {
                        pills = document.createElement('div');
                        pills.id = 'selected-categories-pills';
                        pills.className = 'mt-2 mb-2 flex flex-wrap gap-2';
                        parent.parentNode.insertBefore(pills, parent);
                    }
                    pills.innerHTML = arr.map(c => `<span class="px-3 py-1 rounded-full bg-slate-200 text-slate-700 text-sm">${c}</span>`).join('');
                }
                return arr;
            } catch(e) { return []; }
        }

        // wire checkbox change handlers to keep localStorage and visual state in sync
        function wireCheckboxHandlers() {
            const allCheckboxes = document.querySelectorAll('input[name="category"]');
            allCheckboxes.forEach(cb => {
                cb.addEventListener('change', () => {
                    const label = cb.closest('label');
                    if (label) {
                        if (cb.checked) label.classList.add('bg-slate-100','border-slate-400');
                        else label.classList.remove('bg-slate-100','border-slate-400');
                    }
                    const checked = Array.from(document.querySelectorAll('input[name="category"]:checked')).map(x => x.value);
                    saveSelectedCategories(checked);
                });
            });
        }

        // restore selections immediately on load
        document.addEventListener('DOMContentLoaded', () => {
            restoreSelectedCategories();
            wireCheckboxHandlers();
        });

        async function buildFeed() {
            const buildBtn = document.getElementById('build-feed-btn');
            const summaryOutput = document.getElementById('summary-output');
            
            // Get selected categories
            const checkedBoxes = document.querySelectorAll('input[name="category"]:checked');
            if (checkedBoxes.length === 0) {
                summaryOutput.innerHTML = '<p class="text-slate-500 font-semibold">Please select at least one category first.</p>';
                return;
            }
            const categories = Array.from(checkedBoxes).map(cb => cb.value);
            // persist the chosen categories so a dev-server reload won't lose them
            saveSelectedCategories(categories);

            // Set loading state
            summaryOutput.innerHTML = `
                <div class="flex items-center justify-center p-8">
                    <div class="spinner mr-4"></div>
                    <span class="text-slate-600 font-medium">Building feed, scraping articles, and generating summary...</span>
                </div>`;
            buildBtn.disabled = true;
                buildBtn.innerHTML = '<span>Build & Analyze My Feed</span>';            try {
                const response = await fetch(`${API_URL}/build-and-summarize`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ categories: categories })
                });

                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.error || `HTTP error! Status: ${response.status}`);
                }

                const result = await response.json();
                console.log('build-and-summarize result:', result);

                // Helper to escape text when we must render plain text
                function escapeHtml(text) {
                    if (!text) return '';
                    return text.replace(/&/g, '&amp;')
                               .replace(/</g, '&lt;')
                               .replace(/>/g, '&gt;')
                               .replace(/"/g, '&quot;')
                               .replace(/'/g, '&#039;');
                }

                // Render the per-article findings in the user's requested layout for all articles
                function renderArticles(summaries, categories) {
                    if (!summaries || summaries.length === 0) return '<p class="text-slate-500">No articles returned.</p>';
                    const domainName = categories && categories.length ? categories.join(', ') : 'Your Domain';
                    function splitSentences(text) {
                        return text.split(/(?<=[.!?])\s+/).filter(Boolean);
                    }

                    let out = `<div><h3 class="text-2xl font-bold text-slate-800 mb-6">Article Findings: <span class="text-slate-600">${escapeHtml(domainName)}</span></h3>`;

                    // show only top 5
                    summaries.slice(0,5).forEach((s, idx) => {
                        // s may be an object {key_finding, summary, title, source} or a string
                        let keyFinding = '';
                        let summaryLines = '';
                        let title = '';
                        let source = 'Unknown';
                        let isNumeric = false;
                        if (typeof s === 'object') {
                            keyFinding = s.key_finding || '';
                            summaryLines = s.summary || '';
                            title = s.title || keyFinding;
                            source = s.source || 'Unknown';
                            isNumeric = !!s.is_numeric;
                        } else {
                            const sents = splitSentences(s);
                            keyFinding = sents[0] || s;
                            summaryLines = sents.slice(0,2).join(' ') || s;
                            title = keyFinding;
                        }

                        // Don't truncate key finding - show full text
                        // const kwords = keyFinding.split(/\s+/).filter(Boolean);
                        // if (kwords.length > 15) keyFinding = kwords.slice(0,15).join(' ') + '...';
                        // else if (kwords.length < 8) keyFinding = kwords.slice(0,12).join(' ');

                        // Ensure summary is complete - don't truncate
                        // const swords = summaryLines.split(/\s+/).filter(Boolean);
                        // if (swords.length < 50) {
                        //     // Server already provides 80+ word summaries
                        // }

                        const relevance = `Relevant to ${escapeHtml(domainName)} readers.`;

                        out += `
                            <div class="article-card mt-5 border-2 border-slate-200 rounded-lg p-5 bg-white hover:border-slate-300">
                                <div class="flex items-start gap-3 mb-3">
                                    <div class="flex-grow">
                                        <h3 class="text-lg font-bold text-slate-800">Article ${idx+1}: ${escapeHtml((title || '').slice(0,100))}</h3>
                                        <div class="text-sm text-slate-600 mt-1"><span class="font-semibold text-slate-700">${escapeHtml(source)}</span></div>
                                    </div>
                                </div>
                                <div class="space-y-3 ml-9">
                                    <div>
                                        <p class="font-semibold text-slate-700">Key Finding:</p>
                                        <p class="text-slate-700 mt-1">${escapeHtml(keyFinding)}</p>
                                    </div>
                                    <div>
                                        <p class="font-semibold text-slate-700">Summary:</p>
                                        <p class="text-slate-700 mt-1">${escapeHtml(summaryLines)}</p>
                                        ${isNumeric ? '<p class="mt-2 text-sm italic text-slate-500">Note: Numeric data/tables removed from source</p>' : ''}
                                    </div>
                                    <div class="text-sm text-slate-600 pt-2 border-t border-slate-200">${escapeHtml(relevance)}</div>
                                </div>
                            </div>`;
                    });

                    out += `</div>`;
                    return out;
                }

                // Prefer structured per-article summaries; fall back to server-provided HTML or plain summary
                let articlesHtml = '';
                try {
                    if (result && Array.isArray(result.per_article_summaries) && result.per_article_summaries.length > 0) {
                        articlesHtml = renderArticles(result.per_article_summaries, categories);
                    } else if (result && result.per_article_html) {
                        // server already provided a safe HTML list
                        articlesHtml = result.per_article_html;
                    } else if (result && result.summary_html) {
                        articlesHtml = result.summary_html;
                    } else if (result && result.summary) {
                        articlesHtml = `<div class="p-4">${escapeHtml(result.summary)}</div>`;
                    } else {
                        articlesHtml = '<p class="text-gray-500">No summary returned from server.</p>';
                    }
                } catch (e) {
                    console.error('Error deciding which summary to render', e, result);
                    articlesHtml = '<p class="text-red-500">Failed to render summary (see console).</p>';
                }

                summaryOutput.innerHTML = articlesHtml;
                
                document.getElementById('chat-input').disabled = false;
                document.getElementById('chat-submit').disabled = false;
                document.getElementById('chat-window').innerHTML = `<div class="text-slate-600 font-semibold text-center py-12">Your feed is ready. You can now ask questions!</div>`;
                isFeedBuilt = true;

                // Visually mark selected category labels so the user sees what they selected
                try {
                    const allCheckboxes = document.querySelectorAll('input[name="category"]');
                    allCheckboxes.forEach(cb => {
                        const label = cb.closest('label');
                        if (!label) return;
                        // base classes for checked look
                        if (cb.checked) {
                            label.classList.add('bg-slate-100','border-slate-400');
                        } else {
                            label.classList.remove('bg-slate-100','border-slate-400');
                        }
                    });

                    // Show a small list of selected categories above the summary for clarity
                    const categoryPillsId = 'selected-categories-pills';
                    let pills = document.getElementById(categoryPillsId);
                    if (!pills) {
                        pills = document.createElement('div');
                        pills.id = categoryPillsId;
                        pills.className = 'mt-2 mb-2 flex flex-wrap gap-2';
                        const parent = document.getElementById('summary-output');
                        parent.parentNode.insertBefore(pills, parent);
                    }
                    pills.innerHTML = categories.map(c => `<span class="px-3 py-1 rounded-full bg-slate-200 text-slate-700 text-sm">${c}</span>`).join('');
                } catch (e) {
                    console.warn('Failed to mark selected categories visually', e);
                }

            } catch (error) {
                console.error("Error building feed:", error);
                summaryOutput.innerHTML = `<p class="text-red-500"><b>Error:</b> ${error.message}</p>`;
            } finally {
                buildBtn.disabled = false;
                buildBtn.innerHTML = '<span>ðŸš€</span> <span>Build & Analyze My Feed</span>';
            }
        }

        async function askQuestion() {
            const chatInput = document.getElementById('chat-input');
            const chatSubmit = document.getElementById('chat-submit');
            const chatWindow = document.getElementById('chat-window');
            const question = chatInput.value;

            if (!question || !isFeedBuilt) return;

            // Clear placeholder if first message
            if (chatWindow.innerHTML.includes('Chat history will appear here') || chatWindow.innerHTML.includes('Your feed is ready')) {
                chatWindow.innerHTML = '';
            }

            chatWindow.innerHTML += `<div class="chat-message text-right mb-3"><span class="inline-block bg-slate-700 text-white rounded-xl px-5 py-3 text-sm max-w-xs break-words">${chatInput.value}</span></div>`;
            chatInput.value = '';
            chatSubmit.disabled = true;
            
            chatWindow.innerHTML += `<div id="loading-answer" class="chat-message text-left mb-3"><span class="inline-block bg-slate-100 text-slate-700 rounded-xl px-5 py-3 text-sm border border-slate-300">Thinking...</span></div>`;
            chatWindow.scrollTop = chatWindow.scrollHeight;

            try {
                const response = await fetch(`${API_URL}/ask-my-feed`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ question: question })
                });

                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.error || `HTTP error! Status: ${response.status}`);
                }

                const result = await response.json();
                
                document.getElementById('loading-answer').remove();
                chatWindow.innerHTML += `<div class="chat-message text-left mb-3"><div class="inline-block bg-white text-slate-800 rounded-xl px-5 py-3 text-sm max-w-lg break-words border border-slate-300"><p class="font-semibold text-slate-700 mb-2">Assistant</p><p>${result.answer}</p></div></div>`;

            } catch (error) {
                console.error("Error asking question:", error);
                document.getElementById('loading-answer').remove();
                chatWindow.innerHTML += `<div class="chat-message text-left mb-3"><span class="inline-block bg-red-50 text-red-700 rounded-xl px-5 py-3 text-sm border border-red-200">Error: ${error.message}</span></div>`;
            } finally {
                chatSubmit.disabled = false;
                chatWindow.scrollTop = chatWindow.scrollHeight;
            }
        }

        // Allow Enter key to send message
        document.getElementById('chat-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !document.getElementById('chat-submit').disabled) {
                askQuestion();
            }
        });
    </script>
</body>
</html>